@removeTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model GuideViewModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Railway Audio Guide Prototype — GPS Mode</title>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 20px;
        }

        .station-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .station-button, #startGPSBtn, #startWelcome {
            padding: 10px 16px;
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .station-button:hover, #startGPSBtn:hover, #startWelcome:hover {
            background: #ddd;
        }

        .point {
            padding: 8px;
            border: 1px solid #ddd;
            margin-bottom: 6px;
            border-radius: 6px;
        }

        .active {
            background: #f0fff0;
            border-color: #8f8;
        }

        #gpsInfo {
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Railway Audio Guide — GPS Prototype</h1>

    <!-- Start Welcome Audio -->
    <button id="startWelcome" onclick="document.getElementById('welcomeAudio').play()">Start Welcome Audio</button>
    <audio id="welcomeAudio" src="/audio/welcome_message_sonia.mp3"></audio>

    <!-- Start GPS Button -->
    <button id="startGPSBtn">Start Live GPS Tracking</button>

    <!-- GPS info -->
    <div id="gpsInfo">Current Location: <span id="lat">--</span>, <span id="lon">--</span></div>

    <!-- Station Click Panel (for testing GPS zones) -->
    <div class="station-panel">
        @foreach (var p in Model.AllPoints)
        {
            <button class="station-button" onclick="simulateGPS(@p.Latitude, @p.Longitude)">@p.Name</button>
        }
    </div>

    <!-- Station audio elements -->
    @foreach (var p in Model.AllPoints)
    {
        <audio id="audio_@p.Name.Replace(" ", "")" src="/audio/@p.AudioFile"></audio>
    }

    <script>
        let currentAudio = null;
        let currentPosition = null;

        // Serialize route points safely
        const routePoints = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.AllPoints.Select(p => new {
                name = p.Name,
                lat = p.Latitude,
                lon = p.Longitude,
                radius = p.RadiusMeters,
                audioId = "audio_" + p.Name.Replace(" ", "")
            })
        ));

        // Simulate GPS click
        function simulateGPS(lat, lon) {
            updateGPSDisplay(lat, lon);
            checkGPS(lat, lon);
        }

        // Update displayed latitude/longitude
        function updateGPSDisplay(lat, lon) {
            document.getElementById("lat").innerText = lat.toFixed(6);
            document.getElementById("lon").innerText = lon.toFixed(6);
        }

        // Haversine formula
        function distanceMeters(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = x => x * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
            const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Check GPS against points
        function checkGPS(userLat, userLon) {
            updateGPSDisplay(userLat, userLon);

            routePoints.forEach(p => {
                const d = distanceMeters(userLat, userLon, p.lat, p.lon);
                const audioEl = document.getElementById(p.audioId);
                const divEl = document.getElementById("station_" + p.name.replace(/ /g,''));

                if (!divEl || !audioEl) return;

                if(d <= p.radius) {
                    divEl.classList.add('active');
                    if(currentAudio && !currentAudio.paused && currentAudio !== audioEl) {
                        currentAudio.pause();
                        currentAudio.currentTime = 0;
                    }
                    if(currentAudio !== audioEl) {
                        audioEl.play();
                        currentAudio = audioEl;
                    }
                } else {
                    divEl.classList.remove('active');
                }
            });
        }

        // Start GPS tracking when button clicked
        document.getElementById("startGPSBtn").addEventListener("click", () => {
            if(!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }

            navigator.geolocation.watchPosition(
                (position) => {
                    currentPosition = { lat: position.coords.latitude, lon: position.coords.longitude };
                    checkGPS(currentPosition.lat, currentPosition.lon);
                },
                (error) => {
                    console.error("Error getting location:", error);
                    alert("Unable to get location: " + error.message);
                },
                { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
            );
        });
    </script>

    <h2>Stations</h2>
    <div>
        @foreach (var p in Model.AllPoints)
        {
            <div id="station_@p.Name.Replace(" ", "")" class="point">
                <strong>@p.Name</strong><br />
                <span class="meta">Radius: @p.RadiusMeters m</span>
            </div>
        }
    </div>
</body>
</html>
