@model HotelMVCPrototype.Models.Room

@{
    ViewData["Title"] = $"Room {Model.Number}";
}

<h2>Room @Model.Number</h2>

<div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">

        <!-- LEFT INFO -->
        <div class="d-flex flex-wrap gap-3">
            <span><strong>Type:</strong> @Model.Type</span>
            <span><strong>Status:</strong> @Model.Status</span>
            <span><strong>Floor:</strong> @Model.Floor</span>
        </div>

        <!-- RIGHT BUTTON -->
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm"
               asp-action="RoomHistory"
               asp-route-roomId="@Model.Id">
                📜 Room History
            </a>

            <a class="btn btn-danger btn-sm"
               asp-controller="SecurityIncidents"
               asp-action="Create"
               asp-route-roomId="@Model.Id">
                🚨 Report an Issue
            </a>
        </div>


    </div>
</div>


@if (Model.GuestAssignments.Any(ga => ga.IsActive))
{
    var stay = Model.GuestAssignments.First(ga => ga.IsActive);

    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Current Stay</strong>
            <form asp-action="Depart" method="post"
                  onsubmit="return confirm('Depart all guests and set room to Cleaning?');"
                  class="mb-0">
                @Html.AntiForgeryToken()
                <input type="hidden" name="assignmentId" value="@stay.Id" />
                <button class="btn btn-danger btn-sm">
                    Depart Room
                </button>
            </form>
        </div>
        <div class="card-body">
            <p><strong>Arrival:</strong> @stay.CheckInDate.ToString("dd MMM yyyy")</p>
            <p><strong>Departure:</strong> @stay.CheckOutDate.ToString("dd MMM yyyy")</p>

            <hr />

            <h6>Guests</h6>
            <ul class="list-group">
                @foreach (var g in stay.Guests.OrderByDescending(x => x.IsActive))
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>@g.FirstName @g.LastName</strong><br />
                            <small>
                                @g.Nationality · @g.Sex · Born @g.BirthDate.ToString("dd.MM.yyyy")
                            </small>

                            @if (!g.IsActive && g.DepartedAt != null)
                            {
                                <div class="text-muted mt-1">
                                    Departed: @g.DepartedAt.Value.ToString("dd.MM.yyyy HH:mm")
                                </div>
                            }
                        </div>

                        @if (g.IsActive)
                        {
                            <form asp-action="DepartGuest" method="post" class="mb-0"
                                  onsubmit="return confirm('Depart only this guest?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="guestId" value="@g.Id" />
                                <button class="btn btn-outline-danger btn-sm">
                                    Depart guest
                                </button>
                            </form>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Departed</span>
                        }
                    </li>
                }
            </ul>

        </div>
    </div>
}

else if (Model.Status == HotelMVCPrototype.Models.Enums.RoomStatus.Available)
{
    <div class="card shadow-sm">
        <div class="card-header">
            <strong>Room Available</strong>
        </div>
        <div class="card-body">
            <p>This room is available for check-in.</p>

            <a asp-controller="GuestAssignments"
               asp-action="Create"
               asp-route-roomId="@Model.Id"
               class="btn btn-success">
                New Check-In
            </a>
        </div>
    </div>
}


else
{
    <div class="alert alert-info">
        This room is currently unoccupied.
    </div>
}

<a asp-action="Index" class="btn btn-secondary mt-3">← Back to Dashboard</a>
