@using System.Globalization
@model HotelMVCPrototype.Models.ReceptionDashboardViewModel

@{
    ViewData["Title"] = "Reception Dashboard";
}

<h2>Reception Dashboard</h2>

<div class="row mb-4">
    <div class="col-md-8">
        <partial name="_RoomStatistics" model="Model.RoomStatistics" />


        <div class="floor-plan-container" style="position: relative; width:100%; margin-top: 0; height:auto;">
            <img class="rounded-3" src="@Url.Content($"~/images/HotelFloorPlanF{Model.CurrentFloor}.png")"
                 alt="Floor @Model.CurrentFloor"
                 style="width:100%; height:auto; display:block;" />

            @foreach (var room in Model.RoomMap)
            {
                <div class="room"
                     onclick="location.href='@Url.Action("RoomDetails", "Reception", new { id = room.RoomId })'"
                     id="room-@room.RoomId"
                     data-room-id="@room.RoomId"
                     data-room-number="@room.Number"
                     style="
                     position:absolute;
                     top: @room.TopPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)%;
                     left: @room.LeftPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)%;
                     width: @room.WidthPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)%;
                     height: @room.HeightPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)%;
                     background-color: @room.StatusColor;
                     opacity:0.75;
                     border:2px solid @room.StatusColor;
                     display:flex;
                     align-items:center;
                     justify-content:center;
                     color:white;
                     font-weight:600;
                 ">
                    <div class="room-badges" style="position:absolute; top:2px; right:2px; display:flex; flex-direction:column; gap:2px;">
                        @if (room.IsDND)
                        {
                            <span class="badge bg-warning text-black">DND</span>
                        }

                        @if (room.HasOpenRequest)
                        {
                            <span class="badge bg-danger text-white request-badge">🔔</span>
                        }
                    </div>
                </div>
            }

            <!-- Floor buttons on top of image -->
            <div style="position:absolute; bottom:5px; right:10px;">
                <div class="btn-group" role="group">
                    @for (int i = 1; i <= 3; i++)
                    {
                        <a asp-action="Index"
                           asp-route-floor="@i"
                           class="btn @(Model.CurrentFloor == i ? "btn-primary" : "btn-outline-primary")">
                            Floor @i
                        </a>
                    }
                </div>
            </div>
        </div>



    </div>

 @*    <!-- Requests side window -->
    <div class="col-md-4" id="requests-container">
        <partial name="_ReceptionRequests" model="Model.NewRequests" />
    </div> *@

    <div class="col-md-4" id="requests-container">
        @await Component.InvokeAsync("ReceptionRequests")
    </div>



</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.7/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/hotelHub")
        .build();

    connection.start().catch(err => console.error(err));
</script>
<script>
        connection.on("DndChanged", (roomId, isDnd) => {
        const room = document.getElementById(`room-${roomId}`);
        if (!room) return;

        let badge = room.querySelector(".dnd-badge");

        if (isDnd) {
            if (!badge) {
                badge = document.createElement("span");
                badge.className = "badge bg-warning text-black dnd-badge";
                badge.textContent = "DND";
                room.querySelector(".room-badges").appendChild(badge);
            }
        } else if (badge) {
            badge.remove();
        }
    });


    connection.on("NewRequest", async () => {
        const res = await fetch('/ReceptionRequests/PartialRequests');
        const html = await res.text();
        document.getElementById("requests-container").innerHTML = html;
    });

</script>

<script>
        connection.on("NewRequest", (roomId) => {
        const room = document.getElementById(`room-${roomId}`);
        if (!room) return;

        let badge = room.querySelector(".request-badge");

        if (!badge) {
            badge = document.createElement("span");
            badge.className = "badge bg-danger request-badge";
            badge.textContent = "🔔";
            room.querySelector(".room-badges").appendChild(badge);
        }
    });

        connection.on("RequestCompleted", (roomId) => {
        const room = document.getElementById(`room-${roomId}`);
        if (!room) return;

        const badge = room.querySelector(".request-badge");
        badge?.remove();
    });


</script>




@*< script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.7/signalr.min.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/guestRoomHub")
        .build();

    connection.start().catch(err => console.error(err.toString()));

    // Listen for updates
    connection.on("ReceiveDndUpdate", (roomId, isDnd) => {
        const badge = document.querySelector(`#room-${roomId} .dnd-badge`);
        if (badge) {
            badge.style.display = isDnd ? "block" : "none";
        } else if (isDnd) {
            // Create badge if it doesn't exist
            const roomDiv = document.getElementById(`room-${roomId}`);
            const span = document.createElement("span");
            span.className = "badge bg-warning text-black dnd-badge";
            span.style.position = "absolute";
            span.style.top = "2px";
            span.style.right = "2px";
            span.textContent = "DND";
            roomDiv.appendChild(span);
        }
    });

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/guestRoomHub")
        .build();

      connection.on("ReceiveDndUpdate", function(orderId) {
            // Reload the dashboard or fetch new orders via AJAX
            location.reload();
        });

        connection.start().catch(err => console.error(err.toString()));
</script> *@
@*
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.7/signalr.min.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/requestsHub")
        .build();

    connection.start().catch(err => console.error(err.toString()));

    connection.on("NewRequest", async (requestId) => {
        // Fetch updated ViewComponent
        const res = await fetch('/ReceptionRequests/PartialRequests');
        const html = await res.text();
        document.getElementById("requests-container").innerHTML = html;
    });
</script> *@




