@using System.Globalization
@model HotelMVCPrototype.Models.ReceptionDashboardViewModel

@{
    ViewData["Title"] = "Reception Dashboard";
}

<h2>Reception Dashboard</h2>

<div class="row mb-4">
    <div class="col-md-8">
        <partial name="_RoomStatistics" model="Model.RoomStatistics" />


        <div class="floor-plan-container" style="position: relative; width:100%; margin-top: 0; height:auto;">
            <img class="rounded-3" src="@Url.Content($"~/images/HotelFloorPlanF{Model.CurrentFloor}.png")"
                 alt="Floor @Model.CurrentFloor"
                 style="width:100%; height:auto; display:block;" />

            @foreach (var room in Model.RoomMap)
            {
                <div class="room"
                     onclick="location.href='@Url.Action("RoomDetails", "Reception", new { id = room.RoomId })'"
                     data-room-id="@room.RoomId"
                     data-room-number="@room.Number"
                     style="
                     position:absolute;
                     top: @room.TopPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)%;
                     left: @room.LeftPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)%;
                     width: @room.WidthPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)%;
                     height: @room.HeightPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)%;
                     background-color: @room.StatusColor;
                     opacity:0.75;
                     border:2px solid @room.StatusColor;
                     display:flex;
                     align-items:center;
                     justify-content:center;
                     color:white;
                     font-weight:600;
                 ">
                    @if (room.IsDND)
                    {
                        <span class="badge bg-warning text-black ms-1" style="position:absolute; top:2px; right:2px; opacity:1!important;">
                            DND
                        </span>
                    }
                </div>
            }

            <!-- Floor buttons on top of image -->
            <div style="position:absolute; bottom:5px; right:10px;">
                <div class="btn-group" role="group">
                    @for (int i = 1; i <= 3; i++)
                    {
                        <a asp-action="Index"
                           asp-route-floor="@i"
                           class="btn @(Model.CurrentFloor == i ? "btn-primary" : "btn-outline-primary")">
                            Floor @i
                        </a>
                    }
                </div>
            </div>
        </div>



    </div>

 @*    <!-- Requests side window -->
    <div class="col-md-4" id="requests-container">
        <partial name="_ReceptionRequests" model="Model.NewRequests" />
    </div> *@

    <div class="col-md-4" id="requests-container">
        @await Component.InvokeAsync("ReceptionRequests")
    </div>



</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.7/signalr.min.js"></script>
<script>
    // const connection = new signalR.HubConnectionBuilder()
    //     .withUrl("/guestRoomHub")
    //     .build();

    // connection.start().catch(err => console.error(err.toString()));

    // // Listen for updates
    // connection.on("ReceiveDndUpdate", (roomId, isDnd) => {
    //     const badge = document.querySelector(`#room-${roomId} .dnd-badge`);
    //     if (badge) {
    //         badge.style.display = isDnd ? "block" : "none";
    //     } else if (isDnd) {
    //         // Create badge if it doesn't exist
    //         const roomDiv = document.getElementById(`room-${roomId}`);
    //         const span = document.createElement("span");
    //         span.className = "badge bg-warning text-black dnd-badge";
    //         span.style.position = "absolute";
    //         span.style.top = "2px";
    //         span.style.right = "2px";
    //         span.textContent = "DND";
    //         roomDiv.appendChild(span);
    //     }
    // });

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/guestRoomHub")
        .build();

      connection.on("ReceiveDndUpdate", function(orderId) {
            // Reload the dashboard or fetch new orders via AJAX
            location.reload();
        });

        connection.start().catch(err => console.error(err.toString()));
</script>




