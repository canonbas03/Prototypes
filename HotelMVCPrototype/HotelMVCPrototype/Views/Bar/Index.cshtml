@model List<HotelMVCPrototype.Models.Order>
@{
    ViewData["Title"] = "Bar Dashboard";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Bar Dashboard - New Orders</h2>

    <a class="btn btn-outline-secondary"
       asp-action="History">
        📜 History
    </a>
</div>


@* <h2>Bar Dashboard - New Orders</h2> *@

@if (Model.Any())
{
    <table class="table">
        <thead>
            <tr>
                <th>Room</th>
                <th>Items</th>
                <th>Quantities</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in Model)
            {
                <tr>
                    <td>@order.Room.Number</td>
                    <td>
                        @foreach (var item in order.Items)
                        {
                            <div>@item.MenuItem.Name</div>
                        }
                    </td>
                    <td>
                        @foreach (var item in order.Items)
                        {
                            <div>@item.Quantity</div>
                        }
                    </td>
                    <td>
                        <form asp-action="Complete" method="post">
                            <input type="hidden" name="orderId" value="@order.Id" />
                            <button type="submit" class="btn btn-success">Mark Completed</button>
                        </form>
                    </td>
                </tr>
            }
           
        </tbody>
    </table>
     
}
else
{
    <div class="alert alert-secondary text-center">
        🍹 No new orders at the moment
    </div>
}


<audio id="newOrderSound" preload="auto">
    <source src="@Url.Content("~/sounds/notification-bar.mp3")" type="audio/mpeg" />
</audio>


@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.7/signalr.min.js"></script>
    <script>
        // Unlock audio after the first user gesture
        document.addEventListener("click", async () => {
            const sound = document.getElementById("newOrderSound");
            try {
                sound.volume = 0.8;
                await sound.play();
                sound.pause();
                sound.currentTime = 0;
                console.log("Audio unlocked ✅");
            } catch (e) {
                console.warn("Audio unlock failed:", e);
            }
        }, { once: true });
    </script>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/hotelHub")
            .build();

        connection.on("ReceiveNewOrder", function(orderId) {
            const sound = document.getElementById("newOrderSound");

            // sound.currentTime = 0;
            sound.play().catch(err =>
                {
                    console.warn("Autoplay blocked!", err);
                });

            setTimeout(() => location.reload(), 800);
        });

        connection.start().catch(err => console.error(err.toString()));
    </script>
}

