@removeTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@model GuideViewModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Railway Audio Guide Prototype</title>

    <style>
        body { font-family: Arial, Helvetica, sans-serif; margin: 20px; }
        .point { padding: 8px; border: 1px solid #ddd; margin-bottom: 6px; border-radius: 6px; }
        .active { background: #f0fff0; border-color: #8f8; }
        .controls { margin-bottom: 12px; }
        .meta { color: #666; font-size: .9em; }
        .sim-button { margin-left: 8px; }
    </style>
</head>

<body>
    <h1>Railway Audio Guide — Prototype</h1>

    <div class="controls">
        <form method="get">
            <label>
                GPS Test (seconds):
                <input type="range" min="0" max="300" value="@((int)Model.CurrentOffset.TotalSeconds)"
                       oninput="document.getElementById('gpsVal').value=this.value;">
                <input id="gpsVal" name="gpsOffsetSeconds" value="@((int)Model.CurrentOffset.TotalSeconds)" />
            </label>

            <input type="hidden" name="gps" value="true" />

            <label>offsetSeconds (simulate):
                <input name="offsetSeconds" value="@((int)Model.CurrentOffset.TotalSeconds)" />
            </label>

            <label>side:
                <select name="side">
                    <option value="both" @(Model.SeatSide=="both" ? "selected" : "")>both</option>
                    <option value="left" @(Model.SeatSide=="left" ? "selected" : "")>left</option>
                    <option value="right" @(Model.SeatSide=="right" ? "selected" : "")>right</option>
                </select>
            </label>

            <label>direction:
                <select name="direction">
                    <option value="forward" @(Model.Direction=="forward" ? "selected" : "")>forward</option>
                    <option value="backward" @(Model.Direction=="backward" ? "selected" : "")>backward</option>
                </select>
            </label>

            <label>gps:
                <input type="checkbox" name="gps" value="true" @(Model.UsingGps ? "checked" : "") />
            </label>

            <button type="submit">Update</button>
            <button onclick="currentTime=0; lastPlayedPointId=null;">Restart Simulation</button>

        </form>
    </div>

    <div class="meta">
        Current offset: @Model.CurrentOffset.TotalSeconds seconds. 
        Seat side: @Model.SeatSide. 
        Direction: @Model.Direction. 
        Active: @(Model.ActivePoint?.Name ?? "(none)")
    </div>

    <h2>Route Points</h2>
    <div>
        @foreach (var p in Model.AllPoints)
        {
            var isActive = Model.ActivePoint != null && Model.ActivePoint.Id == p.Id;

            <div id="point_@p.Id" class="point @(isActive ? "active" : "")">
                <strong>@p.Name</strong>
                <span class="meta">(@p.Side) — @p.StartOffset — @p.EndOffset</span>

                <div>@p.Description</div>

                <div style="margin-top:8px;">
                    <button onclick="document.getElementById('audio_@p.Id').play()">Play</button>

                    <!-- Audio file -->
                    <audio id="audio_@p.Id" src="/audio/@p.AudioFile"></audio>

                    @if (isActive)
                    {
                        <span style="margin-left:10px;color:green">▶ Active now</span>
                    }
                </div>
            </div>
        }

        <script>
            const routePoints = [
                @foreach (var p in Model.AllPoints)
                {
                        <text>
                        {
                            id: @p.Id,
                            name: "@p.Name",
                            start: @((int)p.StartOffset.TotalSeconds),
                            end: @((int)p.EndOffset.TotalSeconds),
                            audioFile: "@p.AudioFile"
                        },
                        </text>
                }
            ];
        </script>

    </div>

    <hr />

    <div class="meta">Examples to test quickly (append to /Guide):</div>
    <ul>
        <li>/Guide?offsetSeconds=10 — near Central Station</li>
        <li>/Guide?offsetSeconds=60&side=right — River Bridge</li>
        <li>/Guide?offsetSeconds=85&side=left — Old Fortress</li>
        <li>/Guide?gps=true&gpsOffsetSeconds=150&side=right — force GPS</li>
    </ul>

    @if (Model.ActivePoint != null)
    {
        <script>
            // Autoplay active point
            var audio = document.getElementById('audio_@Model.ActivePoint.Id');
            if (audio) {
                audio.play();
            }
        </script>
    }

    <script>
        let currentTime = 0;            // start at 0 seconds
        const totalTime = 120;          // run for 2 minutes
        let lastPlayedPointId = null;   // avoid playing same sound repeatedly

        function tick() {
            if (currentTime > totalTime) {
                clearInterval(simInterval);
                console.log("Simulation finished.");
                return;
            }

            console.log("Time:", currentTime);

            // Find active point
            const active = routePoints.find(p => currentTime >= p.start && currentTime <= p.end);

            if (active && active.id !== lastPlayedPointId) {
                lastPlayedPointId = active.id;

                // Play associated audio
                const audio = document.getElementById("audio_" + active.id);
                if (audio) {
                    audio.play();
                }

                // Highlight UI (optional)
                document.querySelectorAll(".point").forEach(el => el.classList.remove("active"));
                document.getElementById("point_" + active.id)?.classList.add("active");
            }

            currentTime++;
        }

        // run every second
        const simInterval = setInterval(tick, 1000);
    </script>

</body>
</html>
